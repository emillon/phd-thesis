\section{Contexte}

\subsection{L'arnaque du serrurier}

\begin{frame}{L'arnaque du serrurier}

\begin{itemize}
    \item J'appelle un serrurier
    \item Je l'attends devant \only<1>{\textbf{chez moi}}\only<2>{\textbf{chez mon voisin}}
    \item Il ouvre \only<1>{\textbf{ma porte}}\only<2>{\textbf{sa porte}}
    \item Je rentre \only<1>{\textbf{chez moi}}\only<2>{\textbf{chez mon voisin}}
\end{itemize}
\end{frame}

\begin{frame}{L'arnaque du serrurier -- conclusion}

\begin{itemize}
\item Problème de confiance
\item il ne doit pas appliquer ses droits
\item …mais ceux de l'appelant
\item Il doit vérifier que j'ai bien les droits sur la maison
\end{itemize}

\end{frame}

\subsection{Isolation entre utilisateur et noyau}

\begin{frame}{Espaces utilisateur et noyau}
    \centering
    \begin{tikzpicture}
        [node distance=2cm]
        \node (U) {\parbox{5cm}{Espace utilisateur:\newline programmes (navigateur, …)}};
        \node[below of=U] (K) {Noyau: pilotes};
        \node[below of=K] (H) {Matériel: disque dur, …};
        \draw[<->] (U) -- node [auto] {Appels système} (K);
        \draw[<->] (K) -- node [auto] {Instructions privilégiées} (H);
    \end{tikzpicture}
\end{frame}

% Memory zone
%
% #1 - start
% #2 - end
% #3 - color
\newcommand{\mzone}[3]{
  \path[#3] (#1,0) rectangle (#2,1);
}

% Address label
%
% #1 - x position
% #2 - text
\newcommand{\alabel}[2]{
  \path (#1,1) -- ++(0,0.3) node [pos=1] {\small \tt #2};
}
\newcommand{\addrlabel}[2]{
  \draw[<-] (#1,-0.1) -- ++(0,-0.3) node [auto,pos=1] {\small \tt #2};
  \draw[pattern=north east lines] (#1,0) rectangle ++(0.2,1);
}
\long\def\memzones{

  \mzone{0}{6}{user}
  % exec
  %\mzone{0.5}{1}{user}

  %% lib
  %\mzone{2.5}{3.2}{user}

  %% stack
  %\mzone{3.7}{4}{user}

  %% stack
  %\mzone{5}{5.5}{user}

  % kernel
  \mzone{6}{8}{kernel}

  % contour
  \draw (0,0) rectangle (8,1);

  \alabel{0}{0}
  \alabel{6}{3 Go}
  \alabel{8}{4 Go}

}

%\begin{frame}[fragile]{Séparation}
%\begin{tikzpicture}
%  [user/.style={fill=MellonGreen}
%  ,kernel/.style={fill=MellonPink}
%  ]
%
%  \memzones{}
%
%  \node at (2, -0.7) {Programme};
%  \node at (7, -0.7) {Noyau};
%
%  \draw[>=triangle 45,<->,ultra thick] (3.8, -0.7) -- node[auto] {Appels système} ++(2, 0);
%  \draw[>=triangle 45,<->,ultra thick] (7, -1) -- node[auto,swap] {Instructions
%  privilégiées} ++(0, -1) node (Htop) {};
%
%  \path (Htop) -- ++(-1,-1) node (Htopleft) {};
%  \draw (Htopleft) rectangle ++(2, -2);
%
%  \foreach \x in {0,...,9} {
%      \draw ($ (Htopleft) + (0.1 + 0.2*\x,  0) $) -- ++(0,  0.3);
%      \draw ($ (Htopleft) + (0.1 + 0.2*\x, -2) $) -- ++(0, -0.3);
%      \draw ($ (Htopleft) + (0, -0.2*\x - 0.1) $) -- ++(-0.3, 0);
%      \draw ($ (Htopleft) + (2, -0.2*\x - 0.1) $) -- ++( 0.3, 0);
%   }
%
%  \path (Htop) -- ++(0, -2) node { Matériel };
%
%\end{tikzpicture}
%\end{frame}

\begin{frame}{Espaces noyau et utilisateur}
\centering
\begin{tikzpicture}
  [user/.style={fill=MellonGreen}
  ,kernel/.style={fill=MellonPink}
  ]

  \memzones{}
\end{tikzpicture}
\end{frame}

\begin{frame}{Utilisation correcte d'un appel système}
\centering
    \insertcode{gettimeofday.c}

\begin{tikzpicture}
  [user/.style={fill=MellonGreen}
  ,kernel/.style={fill=MellonPink}
  ]

  \memzones{}
  \addrlabel{2.7}{ptv}
\end{tikzpicture}
\end{frame}

\begin{frame}{Utilisation détournée d'un appel système}
\centering
    \insertcode{gettimeofday-bad.c}

\begin{tikzpicture}
  [user/.style={fill=MellonGreen}
  ,kernel/.style={fill=MellonPink}
  ]

  \memzones{}
  \addrlabel{6.7}{ptv}
\end{tikzpicture}
\end{frame}

% exemple KMS à la place de gettimeofday?

\begin{frame}{Problème des pointeurs dans les appels système}
\begin{itemize}
    \item il faut vérifier tous les pointeurs
    \item fonctions \texttt{copy\_from\_user}, \texttt{copy\_to\_user}
    \item test + \texttt{memcpy}
    \item ou retournent une erreur ($< 0$)
    \item but: détecter les cas où on devrait utiliser \texttt{copy\_*\_user}
\end{itemize}

\begin{center}
\begin{tabular}{cccc}
    \toprule
    & & \multicolumn{2}{p{2cm}}{Contrôlé par \newline (\textbf{statique})} \\
    & & Noyau & Utilisateur \\
    \midrule
\multirow{2}{*}{\parbox{2cm}{Pointe sur \newline (\textbf{dynamique})}}
    & Noyau  & OK & Danger \\
    & Utilisateur & OK & OK \\
    \bottomrule
\end{tabular}
\end{center}

\end{frame}

\input{indus}
