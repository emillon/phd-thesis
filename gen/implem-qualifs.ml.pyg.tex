\begin{Verbatim}[commandchars=\\\{\}]
\PY{k}{let} \PY{k}{rec} \PY{n}{shorten\PYZus{}q} \PY{o}{=} \PY{k}{function}
  \PY{o}{|} \PY{n+nc}{QVar} \PY{o}{(}\PY{o}{\PYZob{}}\PY{n}{contents} \PY{o}{=} \PY{n+nc}{Instanciated} \PY{o}{(}\PY{n+nc}{QVar} \PY{o}{\PYZus{}} \PY{k}{as} \PY{n}{t}\PY{o}{)}\PY{o}{\PYZcb{}} \PY{k}{as} \PY{n}{vt}\PY{o}{)} \PY{o}{\PYZhy{}\PYZgt{}}
      \PY{k}{let} \PY{n}{t2} \PY{o}{=} \PY{n}{shorten\PYZus{}q} \PY{n}{t} \PY{k}{in}
      \PY{n}{vt} \PY{o}{:=} \PY{n+nc}{Instanciated} \PY{n}{t}\PY{o}{;}
      \PY{n}{t2}
  \PY{o}{|} \PY{n+nc}{QVar} \PY{o}{\PYZob{}}\PY{n}{contents} \PY{o}{=} \PY{n+nc}{Instanciated} \PY{n}{t}\PY{o}{\PYZcb{}} \PY{o}{\PYZhy{}\PYZgt{}} \PY{n}{t}
  \PY{o}{|} \PY{n}{t} \PY{o}{\PYZhy{}\PYZgt{}} \PY{n}{t}

\PY{k}{let} \PY{k}{rec} \PY{n}{unify\PYZus{}quals} \PY{n}{a} \PY{n}{b} \PY{o}{=}
  \PY{k}{let} \PY{n}{sa} \PY{o}{=} \PY{n}{shorten\PYZus{}q} \PY{n}{a} \PY{k}{in}
  \PY{k}{let} \PY{n}{sb} \PY{o}{=} \PY{n}{shorten\PYZus{}q} \PY{n}{b} \PY{k}{in}
  \PY{k}{match} \PY{o}{(}\PY{n}{sa}\PY{o}{,} \PY{n}{sb}\PY{o}{)} \PY{k}{with}
  \PY{o}{|} \PY{n+nc}{User}\PY{o}{,} \PY{n+nc}{User} \PY{o}{\PYZhy{}\PYZgt{}} \PY{n+nb+bp}{()}
  \PY{o}{|} \PY{n+nc}{Kernel}\PY{o}{,} \PY{n+nc}{Kernel} \PY{o}{\PYZhy{}\PYZgt{}} \PY{n+nb+bp}{()}
  \PY{o}{|} \PY{o}{(}\PY{o}{(}\PY{n+nc}{QVar} \PY{o}{(}\PY{o}{\PYZob{}}\PY{n}{contents} \PY{o}{=} \PY{n+nc}{Unknown} \PY{n}{na}\PY{o}{\PYZcb{}} \PY{k}{as} \PY{n}{ra}\PY{o}{)}\PY{o}{)}\PY{o}{,}
     \PY{o}{(}\PY{n+nc}{QVar}  \PY{o}{\PYZob{}}\PY{n}{contents} \PY{o}{=} \PY{n+nc}{Unknown} \PY{n}{nb}\PY{o}{\PYZcb{}}\PY{o}{)}\PY{o}{)} \PY{o}{\PYZhy{}\PYZgt{}}
       \PY{k}{begin}
         \PY{k}{if} \PY{n}{na} \PY{o}{\PYZlt{}}\PY{o}{\PYZgt{}} \PY{n}{nb} \PY{k}{then}
           \PY{n}{ra} \PY{o}{:=} \PY{n+nc}{Instanciated} \PY{n}{sb}
       \PY{k}{end}
  \PY{o}{|} \PY{o}{(}\PY{o}{(}\PY{n+nc}{QVar} \PY{o}{(}\PY{o}{\PYZob{}}\PY{n}{contents} \PY{o}{=} \PY{n+nc}{Unknown} \PY{o}{\PYZob{}}\PY{n}{id} \PY{o}{=} \PY{n}{n}\PY{o}{\PYZcb{}}\PY{o}{\PYZcb{}} \PY{k}{as} \PY{n}{r}\PY{o}{)}\PY{o}{)}\PY{o}{,} \PY{n}{q}\PY{o}{)}
    \PY{o}{\PYZhy{}\PYZgt{}}
      \PY{k}{begin}
        \PY{k}{if} \PY{n}{occurs\PYZus{}q} \PY{n}{n} \PY{n}{q} \PY{k}{then}
          \PY{n}{occurs\PYZus{}q\PYZus{}check\PYZus{}failed} \PY{n}{sa} \PY{n}{sb}
        \PY{k}{else}
          \PY{n}{r} \PY{o}{:=} \PY{n+nc}{Instanciated} \PY{n}{q}
      \PY{k}{end}
  \PY{o}{|} \PY{o}{(}\PY{o}{\PYZus{}}\PY{o}{,} \PY{o}{(}\PY{n+nc}{QVar} \PY{o}{(}\PY{o}{\PYZob{}}\PY{n}{contents} \PY{o}{=} \PY{n+nc}{Unknown} \PY{o}{\PYZus{}}\PY{o}{\PYZcb{}}\PY{o}{)}\PY{o}{)}\PY{o}{)} \PY{o}{\PYZhy{}\PYZgt{}} \PY{n}{unify\PYZus{}quals} \PY{n}{sb} \PY{n}{sa}
  \PY{o}{|} \PY{o}{\PYZus{}} \PY{o}{\PYZhy{}\PYZgt{}} \PY{n+nn}{Utils}\PY{p}{.}\PY{n}{error} \PY{l+s+s2}{\PYZdq{}}\PY{l+s+s2}{Cannot unify qualifiers:}\PY{l+s+se}{\PYZbs{}n}\PY{l+s+s2}{  \PYZpc{}s}\PY{l+s+se}{\PYZbs{}n}\PY{l+s+s2}{  \PYZpc{}s}\PY{l+s+se}{\PYZbs{}n}\PY{l+s+s2}{\PYZdq{}}
                        \PY{o}{(}\PY{n}{string\PYZus{}of\PYZus{}qual} \PY{n}{sa}\PY{o}{)}
                        \PY{o}{(}\PY{n}{string\PYZus{}of\PYZus{}qual} \PY{n}{sb}\PY{o}{)}
\end{Verbatim}
